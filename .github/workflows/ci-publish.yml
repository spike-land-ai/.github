name: CI & Publish

on:
  workflow_call:
    inputs:
      node-version:
        type: string
        default: "24"
      build-command:
        type: string
        default: "npm run build"
      test-command:
        type: string
        default: "npm test"
      has-build:
        type: boolean
        default: true
      has-tests:
        type: boolean
        default: true
    secrets:
      GH_PAT_TOKEN:
        description: "PAT with repo scope for dispatching dependency-updated events"
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          registry-url: "https://npm.pkg.github.com"
          scope: "@spike-land-ai"
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --legacy-peer-deps
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Build
        if: inputs.has-build
        run: ${{ inputs.build-command }}
      - name: Test
        if: inputs.has-tests
        run: ${{ inputs.test-command }}

  publish:
    needs: ci
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      publishedPackages: ${{ steps.changesets.outputs.publishedPackages }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          registry-url: "https://npm.pkg.github.com"
          scope: "@spike-land-ai"
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --legacy-peer-deps
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Build
        if: inputs.has-build
        run: ${{ inputs.build-command }}
      - name: Publish to GitHub Packages
        id: changesets
        uses: changesets/action@v1
        with:
          publish: npx changeset publish
          version: npx changeset version
          commit: "chore: version packages"
          title: "chore: version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_REGISTRY: "https://npm.pkg.github.com"

      - name: Publish to npmjs.com
        if: steps.changesets.outputs.published == 'true'
        run: npx changeset publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_REGISTRY: "https://registry.npmjs.org"

  notify:
    needs: publish
    if: needs.publish.outputs.published == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check for PAT token
        id: pat
        run: |
          if [ -n "$TOKEN" ]; then
            echo "present=true" >> $GITHUB_OUTPUT
          else
            echo "present=false" >> $GITHUB_OUTPUT
            echo "GH_PAT_TOKEN not configured — skipping downstream notifications."
            echo "See .github/SETUP.md for instructions on adding the PAT."
          fi
        env:
          TOKEN: ${{ secrets.GH_PAT_TOKEN }}

      - name: Dispatch dependency-updated events to consumers
        if: steps.pat.outputs.present == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT_TOKEN }}
          script: |
            // Load dependency map from the .github repo
            const mapResponse = await github.rest.repos.getContent({
              owner: 'spike-land-ai',
              repo: '.github',
              path: 'dependency-map.json',
            });
            let depMap;
            try {
              depMap = JSON.parse(
                Buffer.from(mapResponse.data.content, 'base64').toString('utf8')
              );
            } catch (err) {
              core.warning(`Failed to parse dependency-map.json: ${err.message}`);
              return;
            }

            const publishedPackages = JSON.parse(process.env.PUBLISHED_PACKAGES || '[]');

            if (!publishedPackages.length) {
              console.log('No packages in publishedPackages output, nothing to dispatch.');
              return;
            }

            for (const { name, version } of publishedPackages) {
              const consumers = depMap[name] || [];
              console.log(`${name}@${version} → consumers: ${consumers.join(', ') || '(none)'}`);
              for (const repo of consumers) {
                core.info(`  Dispatching dependency-updated to spike-land-ai/${repo}`);
                try {
                  await github.rest.repos.createDispatchEvent({
                    owner: 'spike-land-ai',
                    repo,
                    event_type: 'dependency-updated',
                    client_payload: { package: name, version },
                  });
                  core.info(`Dispatched to ${repo}: ${name}@${version}`);
                } catch (err) {
                  core.warning(`Failed to dispatch to ${repo}: ${err.message}`);
                }
              }
            }
        env:
          PUBLISHED_PACKAGES: ${{ needs.publish.outputs.publishedPackages }}
